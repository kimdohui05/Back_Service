# 적금 시스템 V2 (기간별 이자율 + 중도 해지)

## 시스템 개요

**기능**: 일일 납입 적금 계좌 시스템 (기간별 이자율 차등 적용)

**특징**:
- ✅ 기간 선택: 6개월(180일) 또는 1년(365일)
- ✅ 기간별 이자율:
  - 6개월: 1.3% (매일)
  - 1년: 1.5% (매일)
- ✅ 일일 납입: 하루에 한 번만 입금 가능
- ✅ 고정 금액: 10,000원, 30,000원, 50,000원, 100,000원 중 선택
- ✅ 자동 이자: 매일 자정에 기간별 이자율로 이자 자동 적용
- ✅ 입금한 날만 이자 적용: 입금하지 않은 날은 이자가 붙지 않음
- ✅ 중도 해지: 원금만 반환, 이자는 모두 취소
- ✅ 계좌번호 구분: 9로 시작 (일반 계좌는 0으로 시작)

## 이자율 비교

| 기간 | 일수 | 이자율 (매일) | 예상 수익률 |
|------|------|-------------|------------|
| 6개월 | 180일 | 1.3% | 약 11배 (매일 입금 시) |
| 1년 | 365일 | 1.5% | 약 200배 (매일 입금 시) |

**참고**: 1.3%와 1.5%는 일일 이자율입니다. 복리 효과로 최종 수익률은 매우 높습니다.

## 작동 원리

### 1. 적금 개설

```
사용자 입력:
  - 기간: 6개월(180일) 또는 1년(365일)
  - 일일 납입액: 10,000 / 30,000 / 50,000 / 100,000원

시스템 처리:
  - 기간에 따른 이자율 자동 설정
    - 6개월 → 1.3%
    - 1년 → 1.5%
  - 계좌번호 생성 (9로 시작)
  - 초기 잔액: 0원
  - 초기 원금: 0원
```

### 2. 일일 입금

```
입금 조건:
  - 하루에 한 번만 입금 가능
  - 입금액 = 설정한 일일 납입액

입금 처리:
  - 잔액 = 잔액 + 입금액
  - 원금 = 원금 + 입금액 (이자는 원금에 포함 안 됨)
  - 마지막 입금 날짜 업데이트
```

### 3. 자정 이자 적용

```
매일 자정 00:00:00:
  - 어제 입금한 계좌만 조회
  - 각 계좌의 이자율에 따라 이자 계산
  - 이자 = floor(현재 잔액 × (이자율 / 100))
  - 새 잔액 = 현재 잔액 + 이자
  - 원금은 변경 없음 (이자만 잔액에 추가)
```

### 4. 중도 해지

```
중도 해지 시:
  - 반환 금액 = 원금 (이자 제외한 순수 납입 금액)
  - 취소된 이자 = 현재 잔액 - 원금
  - 상태를 CLOSED로 변경

예시:
  - 원금: 100,000원 (10일간 10,000원씩 입금)
  - 현재 잔액: 185,608원 (이자 포함)
  - 해지 시 반환: 100,000원
  - 취소된 이자: 85,608원
```

## 수익 시뮬레이션

### 6개월 (180일, 1.3%)

일일 납입액 10,000원으로 매일 입금 시:

| 일수 | 누적 납입액 | 잔액 (이자 포함) | 원금 | 이자 |
|------|-----------|----------------|------|------|
| 1일 | 10,000원 | 10,130원 | 10,000원 | 130원 |
| 7일 | 70,000원 | 75,915원 | 70,000원 | 5,915원 |
| 30일 | 300,000원 | 459,770원 | 300,000원 | 159,770원 |
| 60일 | 600,000원 | 1,466,233원 | 600,000원 | 866,233원 |
| 90일 | 900,000원 | 3,818,577원 | 900,000원 | 2,918,577원 |
| 120일 | 1,200,000원 | 10,085,891원 | 1,200,000원 | 8,885,891원 |
| 180일 | 1,800,000원 | 약 190,000,000원 | 1,800,000원 | 약 188,200,000원 |

### 1년 (365일, 1.5%)

일일 납입액 10,000원으로 매일 입금 시:

| 일수 | 누적 납입액 | 잔액 (이자 포함) | 원금 | 이자 |
|------|-----------|----------------|------|------|
| 1일 | 10,000원 | 10,150원 | 10,000원 | 150원 |
| 7일 | 70,000원 | 77,813원 | 70,000원 | 7,813원 |
| 30일 | 300,000원 | 524,835원 | 300,000원 | 224,835원 |
| 60일 | 600,000원 | 1,897,773원 | 600,000원 | 1,297,773원 |
| 90일 | 900,000원 | 5,713,826원 | 900,000원 | 4,813,826원 |
| 120일 | 1,200,000원 | 18,324,491원 | 1,200,000원 | 17,124,491원 |
| 180일 | 1,800,000원 | 약 550,000,000원 | 1,800,000원 | 약 548,200,000원 |
| 365일 | 3,650,000원 | 천문학적 수치 | 3,650,000원 | 천문학적 수치 |

**경고**: 1.3%와 1.5% 일일 이자는 복리로 인해 매우 빠르게 증가합니다!

## 중도 해지 예시

### Case 1: 6개월 적금, 30일 후 중도 해지

```
일일 납입액: 10,000원
기간: 6개월 (180일, 이자율 1.3%)

Day 1~30: 매일 10,000원 입금
  - 누적 납입액 (원금): 300,000원
  - 현재 잔액 (이자 포함): 459,770원
  - 누적 이자: 159,770원

30일 후 중도 해지:
  - 반환 금액: 300,000원 (원금만)
  - 취소된 이자: 159,770원
  - 손실: 없음 (원금은 보장)
```

### Case 2: 1년 적금, 60일 후 중도 해지

```
일일 납입액: 30,000원
기간: 1년 (365일, 이자율 1.5%)

Day 1~60: 매일 30,000원 입금
  - 누적 납입액 (원금): 1,800,000원
  - 현재 잔액 (이자 포함): 5,693,319원
  - 누적 이자: 3,893,319원

60일 후 중도 해지:
  - 반환 금액: 1,800,000원 (원금만)
  - 취소된 이자: 3,893,319원
  - 손실: 없음 (원금은 보장)
```

## 데이터베이스 스키마

### 필수 변경 사항

```sql
-- savings 테이블에 컬럼 추가
ALTER TABLE savings
ADD COLUMN last_deposit_date DATE,
ADD COLUMN principal DECIMAL(20, 2) NOT NULL DEFAULT 0;
```

### savings 테이블 전체 구조

```sql
CREATE TABLE savings (
    sid VARCHAR(36) PRIMARY KEY NOT NULL,
    uid VARCHAR(36) NOT NULL,
    acc_number VARCHAR(12) NOT NULL,
    acc_password VARCHAR(4) NOT NULL,
    rate DECIMAL(4, 2) NOT NULL,           -- 이자율 (1.3 또는 1.5)
    start_date DATE NOT NULL,
    status ENUM('ACTIVE', 'MATURED', 'CLOSED') NOT NULL,
    balance DECIMAL(20, 2) NOT NULL,       -- 잔액 (이자 포함)
    principal DECIMAL(20, 2) NOT NULL,     -- 원금 (이자 제외) (NEW!)
    period INT NOT NULL,                   -- 기간 (180 또는 365)
    mthly_deposit INT NOT NULL,            -- 일일 납입액 (10000, 30000, 50000, 100000)
    last_deposit_date DATE,                -- 마지막 입금 날짜 (NEW!)
    FOREIGN KEY (uid) REFERENCES user(uid)
);
```

## API 엔드포인트

### 1. 적금 계좌 개설

```http
POST /api/savings/create
Content-Type: application/json

{
  "uid": "user-uuid",
  "accPassword": "1234",
  "period": 180,         // 180 (6개월) 또는 365 (1년)
  "dailyDeposit": 10000  // 10000, 30000, 50000, 100000
}
```

**응답**:
```
적금 계좌 개설에 성공했습니다
기간: 6개월 (180일)
일일 납입액: 10000원
이자율: 1.3% (매일 자정 적용)
현재 보유하고 있는 적금 계좌번호 : 987654321098
```

### 2. 적금 입금

```http
POST /api/savings/deposit
Content-Type: application/json

{
  "accNumber": "987654321098",
  "amount": 10000
}
```

**응답**:
```
적금 입금 성공
입금액: 10000원
현재 잔액: 10000원 (이자 포함)
현재 원금: 10000원 (이자 제외)
다음 입금 가능 날짜: 2026-02-01
```

### 3. 적금 계좌 조회

```http
GET /api/savings/{accNumber}
```

**응답**:
```json
{
  "sid": "uuid",
  "uid": "user-uuid",
  "accNumber": "987654321098",
  "accPassword": "1234",
  "rate": 1.3,
  "startDate": "2026-01-31",
  "status": "ACTIVE",
  "balance": 10130,      // 이자 포함
  "principal": 10000,    // 이자 제외
  "period": 180,
  "dailyDeposit": 10000,
  "lastDepositDate": "2026-01-31"
}
```

### 4. 적금 해지 (중도 해지)

```http
POST /api/savings/close
Content-Type: application/json

{
  "accNumber": "987654321098",
  "accPassword": "1234"
}
```

**응답**:
```
적금 해지 성공 (중도 해지)
반환 금액: 300000원 (원금만 반환)
취소된 이자: 159770원
원래 잔액: 459770원
※ 중도 해지로 인해 이자는 모두 취소되었습니다
```

## 스케줄러 동작

### SavingsInterestScheduler

**실행 시각**: 매일 자정 00:00:00

**동작**:
1. 어제 날짜 계산 (`LocalDate.now().minusDays(1)`)
2. 어제 입금한 ACTIVE 상태의 적금 계좌들 조회
3. 각 계좌의 이자율에 따라 이자 계산
4. 잔액 업데이트 (원금은 변경 없음)

**로그** (6개월, 1.3%):
```
[SavingsInterestScheduler] 적금 이자 적용 시작 - 대상 계좌 수: 5
[SavingsInterestScheduler] 기준 날짜(어제): 2026-01-30
[SavingsInterestScheduler] 계좌 987654321098: 10000원 → 10130원 (이자: 130원, +1.3%, 원금: 10000원)
[SavingsInterestScheduler] 계좌 987654321099: 50000원 → 50650원 (이자: 650원, +1.3%, 원금: 50000원)
[SavingsInterestScheduler] 적금 이자 적용 완료 - 업데이트된 계좌 수: 5
```

**로그** (1년, 1.5%):
```
[SavingsInterestScheduler] 계좌 987654321100: 100000원 → 101500원 (이자: 1500원, +1.5%, 원금: 100000원)
```

## 주요 특징

### 1. 원금 보장

- 중도 해지 시에도 **원금은 100% 반환**
- 이자만 취소되므로 손실 없음
- `principal` 필드로 원금을 별도 추적

### 2. 기간별 차등 이자율

- 6개월 (180일): 1.3%
- 1년 (365일): 1.5%
- 장기 가입자에게 더 높은 이자율 제공

### 3. 복리 효과

- 매일 이자가 잔액에 추가
- 다음 날 이자는 (원금 + 누적 이자)에 대해 계산
- 시간이 지날수록 이자 증가폭이 커짐

### 4. 입금 추적

- `lastDepositDate`로 마지막 입금 날짜 추적
- 하루에 한 번만 입금 가능
- 입금하지 않은 날은 이자 없음

## 테스트 방법

### 1. 6개월 적금 개설 및 테스트

```bash
# 1. 6개월 적금 개설 (180일, 1.3%)
curl -X POST http://localhost:8080/api/savings/create \
  -H "Content-Type: application/json" \
  -d '{
    "uid":"user-uuid",
    "accPassword":"1234",
    "period":180,
    "dailyDeposit":10000
  }'

# 2. 입금
curl -X POST http://localhost:8080/api/savings/deposit \
  -H "Content-Type: application/json" \
  -d '{"accNumber":"987654321098","amount":10000}'

# 3. 계좌 조회
curl http://localhost:8080/api/savings/987654321098
# → 잔액: 10,000원, 원금: 10,000원

# 4. 자정 대기 (또는 스케줄러 테스트 모드)

# 5. 계좌 조회 (이자 적용 확인)
curl http://localhost:8080/api/savings/987654321098
# → 잔액: 10,130원, 원금: 10,000원 (이자 130원 추가)
```

### 2. 1년 적금 개설 및 테스트

```bash
# 1. 1년 적금 개설 (365일, 1.5%)
curl -X POST http://localhost:8080/api/savings/create \
  -H "Content-Type: application/json" \
  -d '{
    "uid":"user-uuid",
    "accPassword":"1234",
    "period":365,
    "dailyDeposit":30000
  }'

# 2. 입금
curl -X POST http://localhost:8080/api/savings/deposit \
  -H "Content-Type: application/json" \
  -d '{"accNumber":"987654321099","amount":30000}'

# 3. 자정 후 조회
curl http://localhost:8080/api/savings/987654321099
# → 잔액: 30,450원, 원금: 30,000원 (이자 450원 추가)
```

### 3. 중도 해지 테스트

```bash
# 30일간 매일 10,000원 입금 후 해지
curl -X POST http://localhost:8080/api/savings/close \
  -H "Content-Type: application/json" \
  -d '{"accNumber":"987654321098","accPassword":"1234"}'

# 응답:
# 적금 해지 성공 (중도 해지)
# 반환 금액: 300000원 (원금만 반환)
# 취소된 이자: 159770원
# 원래 잔액: 459770원
```

## FAQ

**Q1: 왜 6개월과 1년만 선택 가능한가요?**
- A: 시스템 정책으로 180일(6개월) 또는 365일(1년)만 선택 가능합니다.

**Q2: 중도 해지하면 손해인가요?**
- A: 원금은 100% 반환되므로 손해는 없습니다. 다만 이자는 모두 취소됩니다.

**Q3: 입금하지 않은 날도 이자가 붙나요?**
- A: 아니요. 입금한 날만 다음 날 자정에 이자가 적용됩니다.

**Q4: 1.3%와 1.5%가 너무 높은 것 아닌가요?**
- A: 네, 일일 이자율 1.3%와 1.5%는 매우 높습니다. 테스트/데모용 설정입니다.

**Q5: 이자율을 변경하려면?**
- A: `SavingsService.java`에서 상수 수정:
  ```java
  private static final double RATE_6_MONTHS = 0.5;  // 0.5%로 변경
  private static final double RATE_1_YEAR = 0.8;    // 0.8%로 변경
  ```

**Q6: 만기가 되면 자동으로 상태가 바뀌나요?**
- A: 현재는 자동 만기 처리가 구현되어 있지 않습니다. 추가 구현 필요.

**Q7: 원금은 어떻게 계산되나요?**
- A: 입금할 때마다 원금에 추가됩니다. 이자는 원금에 포함되지 않습니다.

## 주의사항

⚠️ **데이터베이스 마이그레이션 필수**:
```sql
ALTER TABLE savings
ADD COLUMN last_deposit_date DATE,
ADD COLUMN principal DECIMAL(20, 2) NOT NULL DEFAULT 0;
```

⚠️ **일일 이자율 주의**:
- 1.3%와 1.5% 일일 이자는 복리로 매우 빠르게 증가합니다
- 실제 금융 상품의 연 3-5%와 비교하면 매우 높습니다
- 테스트/데모용 설정입니다

⚠️ **중도 해지 시 이자 취소**:
- 원금만 반환되므로 이자는 모두 사라집니다
- 만기까지 유지하는 것이 유리합니다

## 요약

**변경 사항**:
- ✅ 기간 선택: 6개월(180일) 또는 1년(365일)
- ✅ 기간별 이자율: 6개월 1.3%, 1년 1.5%
- ✅ 원금 추적: principal 필드 추가
- ✅ 중도 해지: 원금만 반환, 이자 전액 취소
- ✅ 입금 시 원금 증가, 이자 적용 시 잔액만 증가

**다음 단계**:
1. DB 마이그레이션 실행
2. 서버 시작
3. 6개월/1년 적금 개설 테스트
4. 입금 및 이자 적용 확인
5. 중도 해지 테스트
