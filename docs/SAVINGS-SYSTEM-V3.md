# 적금 시스템 V3 (이자율 감소 기능)

## 시스템 개요

**최신 버전**: V3 (2026-01-31)

**새로운 기능**:
- ✅ 입금하지 않은 날마다 이자율 감소
- ✅ 기간별 차등 감소율
  - 6개월: 0.05%씩 감소
  - 1년: 0.01%씩 감소
- ✅ 최소 이자율: 0% (0% 아래로는 떨어지지 않음)

**기존 기능** (V1, V2):
- 기간 선택: 6개월(180일) 또는 1년(365일)
- 기간별 초기 이자율: 6개월 1.3%, 1년 1.5%
- 일일 납입액: 10,000 / 30,000 / 50,000 / 100,000원
- 하루에 한 번만 입금 가능
- 매일 자정 이자 적용 (입금한 날만)
- 중도 해지 시 원금만 반환
- 계좌번호 9로 시작

---

## 이자율 시스템 상세

### 1. 초기 이자율

| 기간 | 일수 | 초기 이자율 |
|------|------|----------|
| 6개월 | 180일 | 1.3% |
| 1년 | 365일 | 1.5% |

### 2. 이자율 감소

입금하지 않은 날마다 현재 이자율이 감소합니다.

| 기간 | 감소율 (일일) | 0%까지 걸리는 기간 |
|------|-------------|-----------------|
| 6개월 | 0.05% | 26일 (1.3 ÷ 0.05) |
| 1년 | 0.01% | 150일 (1.5 ÷ 0.01) |

**규칙**:
- 입금한 날: 이자율 변동 없음, 현재 이자율로 이자 적용
- 입금하지 않은 날: 이자율 감소, 이자 적용 안 됨
- 최소 이자율: 0% (더 이상 감소하지 않음)

### 3. 이자 적용

```
이자 = floor(현재 잔액 × (현재 이자율 / 100))
새 잔액 = 현재 잔액 + 이자
```

**중요**: 현재 이자율(`current_rate`)을 사용하여 이자 계산

---

## 동작 시나리오

### 시나리오 1: 6개월 적금, 연속 입금

**설정**:
- 기간: 6개월 (180일)
- 초기 이자율: 1.3%
- 일일 납입액: 10,000원

**진행**:
```
Day 1 (입금):
  - 입금: 10,000원
  - 잔액: 10,000원
  - 원금: 10,000원
  - 현재 이자율: 1.3%

Day 2 자정 (이자 적용):
  - 이자: 10,000 × 0.013 = 130원
  - 잔액: 10,000 + 130 = 10,130원
  - 원금: 10,000원 (변동 없음)
  - 현재 이자율: 1.3% (변동 없음)

Day 2 (입금):
  - 입금: 10,000원
  - 잔액: 10,130 + 10,000 = 20,130원
  - 원금: 10,000 + 10,000 = 20,000원
  - 현재 이자율: 1.3%

Day 3 자정 (이자 적용):
  - 이자: 20,130 × 0.013 = 261원
  - 잔액: 20,130 + 261 = 20,391원
  - 원금: 20,000원
  - 현재 이자율: 1.3%
```

### 시나리오 2: 6개월 적금, 입금하지 않은 날

**진행**:
```
Day 1 (입금):
  - 입금: 10,000원
  - 잔액: 10,000원
  - 원금: 10,000원
  - 현재 이자율: 1.3%

Day 2 자정 (이자 적용):
  - 이자: 130원
  - 잔액: 10,130원
  - 원금: 10,000원
  - 현재 이자율: 1.3%

Day 2 (입금 안 함):
  - 잔액: 10,130원 (변동 없음)
  - 원금: 10,000원
  - 현재 이자율: 1.3%

Day 3 자정 (이자율 감소):
  - 이자: 적용 안 됨 (어제 입금 안 했으므로)
  - 잔액: 10,130원 (변동 없음)
  - 원금: 10,000원
  - 현재 이자율: 1.3% - 0.05% = 1.25% ⬇️

Day 3 (입금):
  - 입금: 10,000원
  - 잔액: 10,130 + 10,000 = 20,130원
  - 원금: 10,000 + 10,000 = 20,000원
  - 현재 이자율: 1.25%

Day 4 자정 (감소된 이자율로 이자 적용):
  - 이자: 20,130 × 0.0125 = 251원 (이전보다 적음!)
  - 잔액: 20,130 + 251 = 20,381원
  - 원금: 20,000원
  - 현재 이자율: 1.25% (변동 없음)
```

### 시나리오 3: 1년 적금, 연속으로 입금 안 함

**진행**:
```
Day 1 (입금):
  - 입금: 10,000원
  - 현재 이자율: 1.5%

Day 2 자정:
  - 이자: 150원
  - 잔액: 10,150원
  - 현재 이자율: 1.5%

Day 2~10 (연속 9일 입금 안 함):
Day 3 자정: 현재 이자율 1.49% (0.01% 감소)
Day 4 자정: 현재 이자율 1.48%
Day 5 자정: 현재 이자율 1.47%
...
Day 11 자정: 현재 이자율 1.41%

Day 11 (입금):
  - 입금: 10,000원
  - 잔액: 10,150 + 10,000 = 20,150원
  - 원금: 20,000원
  - 현재 이자율: 1.41%

Day 12 자정 (감소된 이자율로):
  - 이자: 20,150 × 0.0141 = 284원
  - 잔액: 20,434원
  - 현재 이자율: 1.41%
```

### 시나리오 4: 이자율이 0%에 도달

**6개월 적금**:
```
초기 이자율: 1.3%
감소율: 0.05% / 일

26일 연속 입금 안 하면:
1.3% - (0.05% × 26) = 0.0%

Day 27 자정:
  - 현재 이자율: 0% (더 이상 감소 안 함)

Day 28 자정:
  - 현재 이자율: 0% (유지)

Day 29 (입금):
  - 현재 이자율: 0%

Day 30 자정 (이자 적용):
  - 이자: 잔액 × 0.00 = 0원
  - 이자율: 0% (유지)
```

**경고**: 이자율이 0%가 되면 입금해도 이자가 붙지 않습니다!

---

## 데이터베이스 스키마

### 필수 마이그레이션

```sql
-- V1: 마지막 입금 날짜
ALTER TABLE savings
ADD COLUMN last_deposit_date DATE;

-- V2: 원금 추적
ALTER TABLE savings
ADD COLUMN principal DECIMAL(20, 2) NOT NULL DEFAULT 0;

-- V3: 현재 이자율 (NEW!)
ALTER TABLE savings
ADD COLUMN current_rate DECIMAL(4, 2) NOT NULL DEFAULT 0;
```

### savings 테이블 전체 구조

```sql
CREATE TABLE savings (
    sid VARCHAR(36) PRIMARY KEY NOT NULL,
    uid VARCHAR(36) NOT NULL,
    acc_number VARCHAR(12) NOT NULL,
    acc_password VARCHAR(4) NOT NULL,

    rate DECIMAL(4, 2) NOT NULL,           -- 초기 이자율 (고정, 변경 안 됨)
    current_rate DECIMAL(4, 2) NOT NULL,   -- 현재 이자율 (변동, V3에서 추가)

    start_date DATE NOT NULL,
    status ENUM('ACTIVE', 'MATURED', 'CLOSED') NOT NULL,

    balance DECIMAL(20, 2) NOT NULL,       -- 잔액 (이자 포함)
    principal DECIMAL(20, 2) NOT NULL,     -- 원금 (이자 제외)

    period INT NOT NULL,                   -- 기간 (180 또는 365)
    mthly_deposit INT NOT NULL,            -- 일일 납입액

    last_deposit_date DATE,                -- 마지막 입금 날짜

    FOREIGN KEY (uid) REFERENCES user(uid)
);
```

**필드 설명**:
- `rate`: 초기 이자율 (6개월 1.3%, 1년 1.5%) - **변경 안 됨**
- `current_rate`: 현재 이자율 - **입금 안 하면 감소**
- `balance`: 이자 포함 잔액
- `principal`: 이자 제외 원금
- `last_deposit_date`: 마지막 입금 날짜 (이자율 감소 판단용)

---

## API 엔드포인트

### 1. 적금 계좌 개설

```http
POST /api/savings/create
Content-Type: application/json

{
  "uid": "user-uuid",
  "accPassword": "1234",
  "period": 180,         // 180 (6개월) 또는 365 (1년)
  "dailyDeposit": 10000  // 10000, 30000, 50000, 100000
}
```

**응답**:
```
적금 계좌 개설에 성공했습니다
기간: 6개월 (180일)
일일 납입액: 10000원
이자율: 1.3% (매일 자정 적용)
현재 보유하고 있는 적금 계좌번호 : 987654321098
```

**시스템 처리**:
- `rate = 1.3%` (고정)
- `current_rate = 1.3%` (초기값)

### 2. 적금 계좌 조회

```http
GET /api/savings/{accNumber}
```

**응답**:
```json
{
  "sid": "uuid",
  "uid": "user-uuid",
  "accNumber": "987654321098",
  "rate": 1.3,           // 초기 이자율 (고정)
  "currentRate": 1.25,   // 현재 이자율 (변동)
  "balance": 20381,      // 잔액 (이자 포함)
  "principal": 20000,    // 원금 (이자 제외)
  "period": 180,
  "dailyDeposit": 10000,
  "lastDepositDate": "2026-01-31"
}
```

**확인 사항**:
- `currentRate < rate`: 입금하지 않은 날이 있었음
- `currentRate == 0.0`: 이자가 더 이상 붙지 않음

---

## 스케줄러 동작

### SavingsInterestScheduler

**실행 시각**: 매일 자정 00:00:00

**처리 순서**:

1. **어제 입금한 계좌 조회**:
```sql
SELECT * FROM savings
WHERE status = 'ACTIVE' AND last_deposit_date = '2026-01-30';
```

2. **이자 적용** (각 계좌):
```java
이자 = floor(balance × (current_rate / 100.0))
새 잔액 = balance + 이자
```

3. **어제 입금하지 않은 계좌 조회**:
```sql
SELECT * FROM savings
WHERE status = 'ACTIVE'
  AND (last_deposit_date IS NULL OR last_deposit_date != '2026-01-30');
```

4. **이자율 감소** (각 계좌):
```java
if (period == 180) {
    감소량 = 0.05%
} else if (period == 365) {
    감소량 = 0.01%
}

새 이자율 = max(0.0, current_rate - 감소량)
```

**로그 예시**:
```
[SavingsInterestScheduler] 적금 처리 시작
[SavingsInterestScheduler] 기준 날짜(어제): 2026-01-30

[이자 적용] 대상 계좌 수: 3
[이자 적용] 계좌 987654321098: 10000원 → 10130원 (이자: 130원, 현재 이자율: 1.30%, 원금: 10000원)
[이자 적용] 계좌 987654321099: 50000원 → 50650원 (이자: 650원, 현재 이자율: 1.30%, 원금: 50000원)
[이자 적용 완료] 업데이트된 계좌 수: 3

[이자율 감소] 대상 계좌 수: 2
[이자율 감소] 계좌 987654321100: 1.30% → 1.25% (0.05% 감소, 기간: 180일)
[이자율 감소] 계좌 987654321101: 1.50% → 1.49% (0.01% 감소, 기간: 365일)
[이자율 감소 완료] 업데이트된 계좌 수: 2

[SavingsInterestScheduler] 적금 처리 완료
```

---

## 테스트 방법

### 빠른 테스트 (테스트 모드)

`SavingsInterestScheduler.java` 수정:

```java
// 프로덕션 모드 주석 처리
// @Scheduled(cron = "0 0 0 * * *")

// 테스트 모드 활성화
@Scheduled(fixedRate = 60000) // 1분마다
```

### 테스트 시나리오

```bash
# 1. 6개월 적금 개설
curl -X POST http://localhost:8080/api/savings/create \
  -H "Content-Type: application/json" \
  -d '{
    "uid":"user-uuid",
    "accPassword":"1234",
    "period":180,
    "dailyDeposit":10000
  }'
# 응답: 계좌번호 987654321098

# 2. 입금
curl -X POST http://localhost:8080/api/savings/deposit \
  -H "Content-Type: application/json" \
  -d '{"accNumber":"987654321098","amount":10000}'

# 3. 계좌 조회
curl http://localhost:8080/api/savings/987654321098
# 결과: balance=10000, principal=10000, currentRate=1.3

# 4. 1분 대기 (스케줄러 실행)

# 5. 계좌 조회 (이자 적용 확인)
curl http://localhost:8080/api/savings/987654321098
# 결과: balance=10130, principal=10000, currentRate=1.3

# 6. 1분 대기 (입금 안 함)

# 7. 계좌 조회 (이자율 감소 확인)
curl http://localhost:8080/api/savings/987654321098
# 결과: balance=10130, principal=10000, currentRate=1.25 ⬇️
```

---

## 주의사항

### 1. 입금하지 않으면 이자율이 급격히 감소

**6개월 적금**:
- 26일 안 넣으면 이자율 0%
- 이자율 0%가 되면 입금해도 이자 안 붙음

**1년 적금**:
- 150일 안 넣으면 이자율 0%
- 장기적으로 더 유리하지만 꾸준히 입금 필요

### 2. 이자율 회복 불가

한 번 감소한 이자율은 **회복되지 않습니다**.

```
현재 이자율: 1.3% → 1.25% → 1.20% ...
입금을 해도: 1.20% (유지)
```

초기 이자율(`rate`)로 돌아갈 수 없습니다.

### 3. 중도 해지 시 이자 전액 취소

```bash
curl -X POST http://localhost:8080/api/savings/close \
  -H "Content-Type: application/json" \
  -d '{"accNumber":"987654321098","accPassword":"1234"}'
```

**응답**:
```
적금 해지 성공 (중도 해지)
반환 금액: 300000원 (원금만 반환)
취소된 이자: 159770원
원래 잔액: 459770원
※ 중도 해지로 인해 이자는 모두 취소되었습니다
```

원금은 보장되지만, 이자는 모두 사라집니다.

---

## 비교표

### V1 vs V2 vs V3

| 기능 | V1 | V2 | V3 |
|------|----|----|-----|
| 일일 납입 | ✅ | ✅ | ✅ |
| 이자 적용 | ✅ (11%) | ✅ (1.3%, 1.5%) | ✅ (변동) |
| 기간 선택 | ❌ | ✅ | ✅ |
| 원금 추적 | ❌ | ✅ | ✅ |
| 중도 해지 | ❌ | ✅ | ✅ |
| 이자율 감소 | ❌ | ❌ | ✅ |

---

## FAQ

**Q1: 이자율이 0%가 되면 어떻게 되나요?**
- A: 입금은 가능하지만 이자가 붙지 않습니다. 원금만 계속 쌓입니다.

**Q2: 감소한 이자율을 복구할 수 있나요?**
- A: 아니요. 한 번 감소한 이자율은 복구되지 않습니다.

**Q3: 6개월과 1년 중 어느 것이 유리한가요?**
- A:
  - 6개월: 초기 이자율 낮지만 감소 느림 (26일)
  - 1년: 초기 이자율 높지만 감소 빠름 (150일)
  - 꾸준히 입금할 자신 있으면 1년, 아니면 6개월

**Q4: 이자율 감소를 막으려면?**
- A: 매일 입금하면 됩니다. 입금한 날은 이자율이 감소하지 않습니다.

**Q5: 현재 이자율은 어디서 확인하나요?**
- A: 계좌 조회 시 `currentRate` 필드를 확인하세요.

---

**마지막 업데이트**: 2026-01-31
**버전**: V3 (이자율 감소 기능 추가)
